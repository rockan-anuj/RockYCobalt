name: android_arm_manual

on:
  workflow_dispatch:

jobs:
  android-arm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bison clang nasm ninja-build \
            libasound2-dev libgles2-mesa-dev \
            libglib2.0-dev libxcomposite-dev \
            libxi-dev libxrender-dev \
            gcc-multilib g++-multilib libc6-dev-i386 \
            python3-venv unzip curl ccache

      - name: Install GN
        run: |
          wget https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/latest -O gn.zip
          unzip gn.zip
          sudo mv gn /usr/local/bin/
          sudo chmod +x /usr/local/bin/gn

      - name: Setup Android SDK
        run: |
          export ANDROID_HOME=$HOME/android-sdk
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          bash ./starboard/android/shared/download_sdk.sh
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: GN Generate
        run: |
          gn gen out/android-arm_gold --args='
            target_platform="android-arm"
            target_os="android"
            target_cpu="arm"
            build_type="gold"
            sb_api_version=15
          '

      - name: Build Cobalt
        run: |
          NINJA_STATUS="[%e sec | %f/%t %u | %c/sec]"
          ninja -C out/android-arm_gold cobalt_install

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: cobalt-android-arm
          path: out/android-arm_gold/cobalt.apk
